#!/usr/bin/env bash
# Rebuild NixOS with local keystone changes without requiring commits
# Usage: ./bin/keystone-dev [--build] <hostname>
#        ./bin/keystone-dev          # switch using current hostname
#        ./bin/keystone-dev --build  # build only using current hostname

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(dirname "$SCRIPT_DIR")"
KEYSTONE_PATH="$REPO_ROOT/.submodules/keystone"

BUILD_ONLY=false
HOSTNAME=""

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    --build)
      BUILD_ONLY=true
      shift
      ;;
    *)
      HOSTNAME="$1"
      shift
      ;;
  esac
done

HOSTNAME="${HOSTNAME:-$(hostname)}"

echo "Using local keystone from: $KEYSTONE_PATH"
echo "Target hostname: $HOSTNAME"

if $BUILD_ONLY; then
  echo "Building only (not switching)..."
  nix build "$REPO_ROOT#nixosConfigurations.$HOSTNAME.config.system.build.toplevel" \
    --override-input keystone "path:$KEYSTONE_PATH"
else
  echo "Rebuilding and switching..."
  sudo nixos-rebuild switch --flake "$REPO_ROOT#$HOSTNAME" \
    --override-input keystone "path:$KEYSTONE_PATH"
fi
