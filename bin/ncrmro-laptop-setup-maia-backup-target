#!/usr/bin/env bash

# This script creates the necessary ZFS dataset on maia.mercury to receive snapshots from ncrmro-laptop
# Run this script once to set up the receiving dataset structure

set -e

echo "Setting up backup target on maia.mercury..."

# Use a single SSH connection with heredoc to run all commands
ssh root@maia.mercury <<'EOF'
  set -e
  # Because we are running with --no-sync-snap and --skip-parent we need to ensure cryptswap is present as that is where all the OS child datasets are
  # Credstore will be created under rpoo/credstore and must be present to unlock cryptswap
  echo "Creating ZFS dataset for ncrmro-laptop backups..."
  zfs create -o mountpoint=none -p lake/backups/ncrmro-laptop/rpool/crypt
  
  echo "Setting permissions for laptop-sync user..."
  zfs allow laptop-sync create,receive,mount,compression,mountpoint,readonly,keylocation lake/backups/ncrmro-laptop
  
  echo "Setup completed successfully on maia.mercury"
EOF

if [ $? -eq 0 ]; then
  echo "Successfully created backup dataset on maia.mercury"
  echo "Replication can now be started from ncrmro-laptop"
else
  echo "Error: Failed to set up backup target on maia.mercury"
  echo "Check the error messages above for details"
  exit 1
fi
