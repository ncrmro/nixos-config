#!/usr/bin/env bash
set -e

echo "Creating Ceph filesystem test deployment with RWX volume..."

kubectl apply -f - <<'EOF'
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: ceph-filesystem-test-pvc
  namespace: default
spec:
  accessModes:
    - ReadWriteMany
  storageClassName: ceph-filesystem
  resources:
    requests:
      storage: 1Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ceph-filesystem-test
  namespace: default
spec:
  replicas: 2
  selector:
    matchLabels:
      app: ceph-filesystem-test
  template:
    metadata:
      labels:
        app: ceph-filesystem-test
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - ceph-filesystem-test
            topologyKey: kubernetes.io/hostname
      containers:
      - name: test-writer
        image: busybox:latest
        command: ["/bin/sh"]
        args:
        - -c
        - |
          echo "Starting Ceph filesystem test on $(hostname)..."
          while true; do
            echo "=== $(date) ==="
            echo "Writing from $(hostname) to shared filesystem..."
            echo "$(date): Hello from $(hostname)" >> /shared/test-$(hostname).log
            
            echo "Current files in shared directory:"
            ls -la /shared/
            
            echo "Reading all log files:"
            cat /shared/*.log 2>/dev/null || echo "No log files found yet"
            
            echo "Sleeping for 30 seconds..."
            sleep 30
          done
        volumeMounts:
        - name: shared-storage
          mountPath: /shared
        resources:
          requests:
            memory: "64Mi"
            cpu: "100m"
          limits:
            memory: "128Mi"
            cpu: "200m"
      volumes:
      - name: shared-storage
        persistentVolumeClaim:
          claimName: ceph-filesystem-test-pvc
EOF

echo ""
echo "Deployment created! Monitor with:"
echo "kubectl get pods -l app=ceph-filesystem-test"
echo "kubectl logs -l app=ceph-filesystem-test -f"
echo ""
echo "Check PVC status:"
echo "kubectl get pvc ceph-filesystem-test-pvc"
echo ""
echo "Clean up with:"
echo "kubectl delete deployment ceph-filesystem-test"
echo "kubectl delete pvc ceph-filesystem-test-pvc"