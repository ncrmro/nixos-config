#!/usr/bin/env python3
"""
testDesktop - Build and run the test-vm desktop configuration
"""

import os
import sys
import subprocess

# ANSI colors
GREEN = '\033[0;32m'
BLUE = '\033[0;34m'
YELLOW = '\033[1;33m'
NC = '\033[0m'

def log(msg):
    print(f"{BLUE}[testDesktop]{NC} {msg}")

def success(msg):
    print(f"{GREEN}âœ“{NC} {msg}")

def warn(msg):
    print(f"{YELLOW}!{NC} {msg}")

def main():
    # Change to project root directory
    script_dir = os.path.dirname(os.path.abspath(__file__))
    project_root = os.path.dirname(script_dir)
    os.chdir(project_root)

    vm_name = "test-vm"
    result_link = "result-desktop-vm"

    log(f"Building {vm_name} configuration...")
    
    build_cmd = [
        "nix", "build",
        f".#nixosConfigurations.{vm_name}.config.system.build.vm",
        "--out-link", result_link,
        "--show-trace"
    ]

    try:
        subprocess.run(build_cmd, check=True)
    except subprocess.CalledProcessError:
        sys.exit(1)

    success("VM build complete!")
    print("")
    log("Starting VM...")
    warn("VM will auto-login to Hyprland")
    warn("Exit VM: Press Ctrl+A, then X")
    warn("Fullscreen: Press Ctrl+Alt+F")
    print("")

    # Run the VM
    runner = f"./{result_link}/bin/run-nixos-vm"
    try:
        # Use execv to replace the current process
        os.execv(runner, [runner])
    except OSError as e:
        print(f"Error executing VM: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()