#!/usr/bin/env bash
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$SCRIPT_DIR"

VM_NAME="test-vm"
RESULT_LINK="result-desktop-vm"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

log() { echo -e "${BLUE}[testDesktop]${NC} $1"; }
success() { echo -e "${GREEN}âœ“${NC} $1"; }
warn() { echo -e "${YELLOW}!${NC} $1"; }

log "Building keystone-desktop test VM..."
nix build ".#nixosConfigurations.${VM_NAME}.config.system.build.vm" \
    --out-link "${RESULT_LINK}" \
    --show-trace

success "VM build complete!"
echo ""
log "Starting VM..."
warn "VM will auto-login to Hyprland"
warn "Exit VM: Press Ctrl+A, then X"
warn "Fullscreen: Press Ctrl+Alt+F"
echo ""

# Run the VM
exec "${RESULT_LINK}/bin/run-${VM_NAME}-vm"
