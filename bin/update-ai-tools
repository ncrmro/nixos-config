#!/usr/bin/env python3
import subprocess
import re
import sys
import os
from pathlib import Path

# Configuration
GEMINI_VERSION = "0.26.0"
CLAUDE_VERSION = "2.1.30"

REPO_ROOT = Path(__file__).resolve().parent.parent

def run_command(cmd, shell=False, check=True, capture_output=True, text=True):
    try:
        return subprocess.run(cmd, shell=shell, check=check, capture_output=capture_output, text=text)
    except subprocess.CalledProcessError as e:
        e.output = e.stdout
        e.stderr = e.stderr
        raise e

def get_nix_file_path(package_name):
    return REPO_ROOT / "packages" / package_name / "default.nix"

def update_file_content(file_path, replacements):
    with open(file_path, 'r') as f:
        content = f.read()
    
    for pattern, replacement in replacements:
        content = re.sub(pattern, replacement, content)
    
    with open(file_path, 'w') as f:
        f.write(content)

def prefetch_url(url):
    print(f"  Prefetching {url}...")
    result = run_command(["nix-prefetch-url", "--unpack", url])
    base32_hash = result.stdout.strip()
    
    # Convert to SRI
    result_sri = run_command(["nix", "hash", "to-sri", "--type", "sha256", base32_hash])
    return result_sri.stdout.strip()

def get_fake_hash():
    return "sha256-AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA="

def update_gemini():
    print(f"Updating Gemini CLI to {GEMINI_VERSION}...")
    file_path = get_nix_file_path("gemini-cli")
    
    # 1. Update version and get new src hash
    url = f"https://github.com/google-gemini/gemini-cli/archive/refs/tags/v{GEMINI_VERSION}.tar.gz"
    src_hash = prefetch_url(url)
    
    print(f"  New src hash: {src_hash}")
    
    # Update version and src hash, set npmDepsHash to fake
    update_file_content(file_path, [
        (r'version = "[^"]+";', f'version = "{GEMINI_VERSION}";'),
        (r'hash = "sha256-[^"]+";', f'hash = "{src_hash}";'),
        (r'npmDepsHash = "sha256-[^"]+";', f'npmDepsHash = "{get_fake_hash()}";')
    ])
    
    # 2. Build to get npmDepsHash
    print("  Building to determine npmDepsHash (expecting failure)...")
    try:
        run_command(["nix", "build", ".#gemini-cli", "--no-link"], check=True)
    except subprocess.CalledProcessError as e:
        stderr = e.stderr
        match = re.search(r'got:\s+(sha256-[A-Za-z0-9+/=]+)', stderr)
        if match:
            new_npm_hash = match.group(1)
            print(f"  Found new npmDepsHash: {new_npm_hash}")
            update_file_content(file_path, [
                (r'npmDepsHash = "sha256-[^"]+";', f'npmDepsHash = "{new_npm_hash}";')
            ])
        else:
            print("  Could not find new npmDepsHash in stderr. Aborting.")
            print(stderr)
            return False

    # 3. Verify build
    print("  Verifying build...")
    try:
        run_command(["nix", "build", ".#gemini-cli", "--no-link"], check=True)
        print("  Gemini CLI update successful.")
        return True
    except subprocess.CalledProcessError as e:
        print("  Gemini CLI build failed verification.")
        print("  Stdout:", e.stdout)
        print("  Stderr:", e.stderr)
        return False

def update_claude():
    print(f"Updating Claude Code to {CLAUDE_VERSION}...")
    file_path = get_nix_file_path("claude-code")
    
    # 1. Update version and get new src hash
    url = f"https://registry.npmjs.org/@anthropic-ai/claude-code/-/claude-code-{CLAUDE_VERSION}.tgz"
    src_hash = prefetch_url(url)
    
    print(f"  New src hash: {src_hash}")
    
    # Update version and src hash, set npmDepsHash to fake
    update_file_content(file_path, [
        (r'version = "[^"]+";', f'version = "{CLAUDE_VERSION}";'),
        (r'hash = "sha256-[^"]+";', f'hash = "{src_hash}";'),
        (r'npmDepsHash = "sha256-[^"]+";', f'npmDepsHash = "{get_fake_hash()}";')
    ])
    
    # 2. Build to get npmDepsHash
    print("  Building to determine npmDepsHash (expecting failure)...")
    try:
        run_command(["nix", "build", ".#claude-code", "--no-link"], check=True)
    except subprocess.CalledProcessError as e:
        stderr = e.stderr
        match = re.search(r'got:\s+(sha256-[A-Za-z0-9+/=]+)', stderr)
        if match:
            new_npm_hash = match.group(1)
            print(f"  Found new npmDepsHash: {new_npm_hash}")
            update_file_content(file_path, [
                (r'npmDepsHash = "sha256-[^"]+";', f'npmDepsHash = "{new_npm_hash}";')
            ])
        else:
            print("  Could not find new npmDepsHash in stderr. Aborting.")
            print(stderr)
            return False

    # 3. Verify build
    print("  Verifying build...")
    try:
        run_command(["nix", "build", ".#claude-code", "--no-link"], check=True)
        print("  Claude Code update successful.")
        return True
    except subprocess.CalledProcessError as e:
        print("  Claude Code build failed verification.")
        print("  Stdout:", e.stdout)
        print("  Stderr:", e.stderr)
        return False

def main():
    print("Starting update process (Codex ignored)...")
    
    success = True
    
    # We already updated Gemini successfully, but rerunning is fine (idempotent)
    # To save time, we can skip it if the user only wants Claude now?
    # But for robustness, let's keep it or comment it out if needed.
    # The user asked "What about claude?", so I'll focus on Claude.
    # But I'll leave Gemini in to ensure consistency.
    
    if not update_gemini():
        success = False

    print("-" * 40)

    if not update_claude():
        success = False

    if success:
        print("\nAll updates completed successfully!")
    else:
        print("\nSome updates failed.")
        sys.exit(1)

if __name__ == "__main__":
    main()