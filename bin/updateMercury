#!/usr/bin/env bash

HOST="root@mercury.ncrmro.com"

# Rebuild the NixOS configuration via Ocean jumphost
nixos-rebuild switch --flake .#mercury --target-host "$HOST" #--build-host ocean.mercury

# Try to create headscale user 'ncrmro' and ignore errors if output contains 'UNIQUE'
echo "Attempting to create headscale user 'ncrmro'..."
output=$(ssh -J ocean.mercury $HOST "headscale users create ncrmro" 2>&1) || {
  if echo "$output" | grep -q "UNIQUE"; then
    echo "User 'ncrmro' already exists (UNIQUE constraint). Continuing..."
  else
    echo "Error creating user: $output"
    exit 1
  fi
}
